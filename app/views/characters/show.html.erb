<div class="character-id" style="display:none;">
  <%= @character.id %>
</div>

<% if current_user == @character.game.owner %>
  <h1>
    <i class="fa fa-pencil" style="font-size:14px;"></i>
    <%= best_in_place @character, :name, as: :input, place_holder: "Unnamed Character", id: "character_name_#{@character.id}", class: "hoverable", url: game_character_path %>
  </h1>

  <p>
    <i class="fa fa-pencil" style="font-size:14px;"></i>
    <strong>Player:</strong>
    <%= best_in_place @character, :player_email, as: :input, display_as: :display_player_email, place_holder: "No Player Assigned", class: "hoverable", url: game_character_path %>
  </p>

  <p>
    <i class="fa fa-pencil" style="font-size:14px;"></i>
    <strong>Character Information:</strong>
  </p>
  <%= best_in_place @character, :character_sheet, as: :textarea, display_with: :simple_format, place_holder: "Character information goes here", class: "hoverable", :html_attrs => { :cols => '60', :rows => '20' }, url: game_character_path %>

  <p>
    <i class="fa fa-pencil" style="font-size:14px;"></i>
    <strong>Abilities:</strong>
    <div class="abilities-list">
      <% @character_abilities.each do |character_ability| %>
        <span class="ability" data-character-ability-id="<%= character_ability.id %>">
          <span class="delete-ability">✖</span>
          <%= character_ability.ability.name %>
        </span>
      <% end %>
      <select class="ability-select">
        <option value="" selected="selected"></option>
        <% @all_abilities.each do |ability| %>
          <option value="<%= ability.name %>" data-ability-id="<%= ability.id %>"><%= ability.name %></option>
        <% end %>
      </select>
    </div>
  </p>

<% else %>
  <h1><%= @character.name %></h1>

  <p>
    <strong>Game:</strong>
    <%= link_to @character.game.name, @character.game %>
  </p>

  <p>
    <strong>Player:</strong>
    <%= @character.user.display_name unless @character.user.nil? %>
  </p>

  <p>
    <strong>Character Information:</strong>
    <%= simple_format(@character.character_sheet) %>
  </p>

  <p>
    <strong>Abilities:</strong>
    <div class="abilities-list">
      <% @character_abilities.each do |character_ability| %>
        <span class="ability" data-character-ability-id="<%= character_ability.id %>">
          <%= character_ability.ability.name %>
        </span>
      <% end %>
    </div>
  </p>
<% end %>

<p>
  <%= link_to 'Back to %s' % [@character.game.name], game_path(@character.game_id) %>
</p>

<script>
  $('.best_in_place').bind('ajax:success', function() {
    this.innerHTML = this.innerHTML.replace(/\n/g, '<br />');
  });

  $('.ability-select').change(function() {
    var characterId = parseInt($('.character-id').text());
    var abilityId = parseInt($('.ability-select option:selected').data('ability-id'));
    $.ajax({
      url: '/abilities/add',
      type: 'post',
      data: {
        character_id : characterId,
        ability_id : abilityId
      },
      success: function(json) {
        $('<span class="ability" data-character-ability-id="' + json.character_ability_id + '"><span class="delete-ability">✖</span>' + $('.ability-select option:selected').text() + '</span>').insertBefore($('.ability-select'));
        $(this).prop('selectedIndex', 0);        
      }
    });

  });

  $(document).on('click', '.delete-ability', function() {
    var characterAbilityId = $(this).parent('.ability').data('character-ability-id');
    $.ajax({
      url: '/abilities/' + characterAbilityId,
      type: 'delete',
      success: function() {
        $(this).parent('.ability').remove();
      }.bind(this)
    });
  });
</script>
